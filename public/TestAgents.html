
<!doctype html><html lang="en"><head>
    <meta charset="utf-8" />
    <title>Agent2Agent Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; }
      h1 { margin-bottom: 8px; }
      button { margin: 6px 6px 6px 0; padding: 8px 12px; }
      pre { background: #111; color: #0f0; padding: 12px; overflow: auto; max-height: 500px; }
      .row { margin: 10px 0; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 10px 0; }
    </style></head><body>
    <h1>Agent2Agent Shell (BLE Child Safety)</h1>
    <p>Click buttons to call each agent or the full orchestrated chain.</p>
  
    <div class="card">
      <h3>Sample Telemetry</h3>
      <textarea id="telemetry" rows="8" style="width:100%;">
  {
    "buckle_state": "BUCKLED",
    "seat_presence": true,
    "motion_state": "STILL",
    "vehicle_moving": false,
    "gps": {"lat": 29.7604, "lon": -95.3698},
    "outside_temp_f": 92,
    "t_still": 420,
    "t_buckled": 700
  }
      </textarea>
    </div>
  
    <div class="row">
      <button onclick="callAgent('SensingAgent','NORMALIZE_TELEMETRY')">Call SensingAgent</button>
      <button onclick="callAgent('RiskPolicyAgent','EVALUATE_RISK')">Call RiskPolicyAgent</button>
      <button onclick="callAgent('CommsAgent','CRAFT_MESSAGE')">Call CommsAgent</button>
      <button onclick="callAgent('EscalationAgent','DELIVER_OR_ESCALATE')">Call EscalationAgent</button>
      <button onclick="callAgent('ComplianceAgent','APPROVE_OUTBOUND')">Call ComplianceAgent</button>
      <button onclick="orchestrate()">Run Full Orchestration</button>
    </div>
  
    <pre id="out">Output will appear here...</pre>
  
    <script>
      async function callAgent(name, intent) {
        const out = document.getElementById('out');
        out.textContent = 'Calling...';
        try {
          const t = JSON.parse(document.getElementById('telemetry').value);
          // Minimal message to the agent (normally you'd chain previous output)
          const body = {
            type: "A2A_MESSAGE",
            from: "Client",
            to: name,
            intent,
            payload: name === 'SensingAgent'
              ? { telemetry: t }
              : name === 'RiskPolicyAgent'
              ? { features: { present: true, moving: false, T_out: t.outside_temp_f, t_still: t.t_still, t_buckled: t.t_buckled, gps: t.gps } }
              : name === 'CommsAgent'
              ? { state: "ALERT", reason: "Demo reason", context: { T_out: t.outside_temp_f, gps: t.gps, t_still: t.t_still } }
              : name === 'EscalationAgent'
              ? { state: "ALERT", note: { title: "Demo", body: "Please check vehicle" }, context: { gps: t.gps } }
              : name === 'ComplianceAgent'
              ? { plan: { state: "ALERT", steps: [{tier:1, channel:"push"}] }, context: { gps: t.gps } }
              : {},
            trace: [{agent:"Client", intent:"SINGLE_CALL", ts:new Date().toISOString()}]
          };
          const res = await fetch(`/agents/${name}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
          const json = await res.json();
          out.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
          out.textContent = `Error: ${e.message}`;
        }
      }
  
      async function orchestrate() {
        const out = document.getElementById('out');
        out.textContent = 'Running orchestration...';
        try {
          const t = JSON.parse(document.getElementById('telemetry').value);
          const res = await fetch('/orchestrate', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ telemetry: t, acked: false })
          });
          const json = await res.json();
          out.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
          out.textContent = `Error: ${e.message}`;
        }
      }
    </script></body></html>